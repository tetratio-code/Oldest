<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在世最長壽者：日期 × 年齡（讀取 data.json）</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --card:#fafafa; --border:#e7e7e7; }
    body{ margin:0; font-family: system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; color:var(--fg); background:var(--bg); }
    .wrap{ max-width: 1080px; margin: 28px auto; padding: 0 16px 24px; }
    h1{ font-size: 20px; margin: 0 0 8px; }
    .sub{ color: var(--muted); margin: 0 0 14px; line-height: 1.55; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    #chart{ width: 100%; }
    .axis text{ fill: var(--muted); font-size: 12px; }
    .axis path, .axis line{ stroke: #d9d9d9; }
    .grid line{ stroke:#e9e9e9; }
    .grid path{ display:none; }
    .label{ fill: var(--muted); font-size: 12px; }
    .tooltip{
      position: fixed; pointer-events:none; opacity:0;
      background: rgba(20,20,20,.92); color: #fff;
      padding: 10px 12px; border-radius: 10px; max-width: 360px;
      font-size: 12px; line-height: 1.35;
      transform: translate(10px, 10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 0; }
    .pill{ font-size:12px; color:var(--muted); background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; }
    .error{ white-space: pre-wrap; color:#b00020; font-size: 13px; margin-top: 10px; }
    code{ background:#f3f3f3; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>在世最長壽者（世界最高齡在世者）年齡視覺化</h1>
    <p class="sub">
      讀取 <code>data.json</code>（同資料夾）<br/>
      橫軸：日期｜縱軸：該日期年齡（年齡 = (日期 − 出生日期) / 365.2425）
    </p>

    <div class="card">
      <div class="row" id="meta"></div>
      <div id="chart"></div>
      <div class="error" id="err" style="display:none;"></div>
    </div>

    <p class="sub" style="margin-top:14px;">
      若你直接雙擊開啟（file://）而出現 fetch 失敗，請用本機伺服器：<br/>
      macOS/Linux：<code>python3 -m http.server 8000</code>　Windows：<code>python -m http.server 8000</code><br/>
      然後瀏覽器開 <code>http://localhost:8000</code>
    </p>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    const DATA_URL = "./data.json";
    const DAYS_PER_YEAR = 365.2425;

    const tooltip = d3.select("#tooltip");
    const meta = d3.select("#meta");
    const errBox = d3.select("#err");

    function showError(msg){
      errBox.style("display","block").text(msg);
    }

    // 安全解析 YYYY-MM-DD（用 UTC 避免時區偏移）
    function parseISODate(s){
      if (s === null || s === undefined) return null;
      if (typeof s !== "string") return null;
      const m = s.trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = +m[1], mo = +m[2]-1, d = +m[3];
      return new Date(Date.UTC(y, mo, d));
    }

    function yearsBetween(birth, date){
      return (date - birth) / (1000*60*60*24) / DAYS_PER_YEAR;
    }

    function fmtDateTW(d){
      return new Intl.DateTimeFormat("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}).format(d);
    }

    function validateAndNormalize(raw){
      if (!Array.isArray(raw)) throw new Error("data.json 必須是一個陣列（Array）。");

      const today = new Date();
      const segs = [];

      raw.forEach((r, idx) => {
        const name = (r?.name ?? "").toString().trim();
        const birth = parseISODate(r?.birth);
        const start = parseISODate(r?.start);
        const end = (r?.end === null || r?.end === undefined) ? today : parseISODate(r?.end);

        if (!name) throw new Error(`第 ${idx+1} 筆缺少 name。`);
        if (!birth) throw new Error(`第 ${idx+1} 筆 birth 日期格式錯誤，需 YYYY-MM-DD。`);
        if (!start) throw new Error(`第 ${idx+1} 筆 start 日期格式錯誤，需 YYYY-MM-DD。`);
        if (!end) throw new Error(`第 ${idx+1} 筆 end 日期格式錯誤，需 YYYY-MM-DD 或 null。`);
        if (end <= start) throw new Error(`第 ${idx+1} 筆 end 必須晚於 start。`);
        if (start <= birth) throw new Error(`第 ${idx+1} 筆 start 必須晚於 birth（不合理）。`);

        segs.push({
          name,
          country: r?.country ? String(r.country) : "",
          note: r?.note ? String(r.note) : "",
          birth, start, end,
          ageStart: yearsBetween(birth, start),
          ageEnd: yearsBetween(birth, end)
        });
      });

      // 按 start 排序（時間序列）
      segs.sort((a,b) => a.start - b.start);

      return segs;
    }

    function draw(segments){
      d3.select("#chart").selectAll("*").remove();
      meta.selectAll("*").remove();
      errBox.style("display","none").text("");

      const container = document.getElementById("chart");
      const width = Math.max(340, container.clientWidth);
      const height = 540;

      const margin = { top: 18, right: 22, bottom: 52, left: 64 };
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      // meta
      meta.append("div").attr("class","pill").text(`段數：${segments.length}`);
      meta.append("div").attr("class","pill").text(`區間：${fmtDateTW(d3.min(segments, d=>d.start))} → ${fmtDateTW(d3.max(segments, d=>d.end))}`);

      const svg = d3.select("#chart")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("width", "100%")
        .attr("height", height);

      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleTime()
        .domain([d3.min(segments, d=>d.start), d3.max(segments, d=>d.end)])
        .nice()
        .range([0, innerW]);

      const y = d3.scaleLinear()
        .domain([
          d3.min(segments, d=>Math.min(d.ageStart, d.ageEnd)) - 0.3,
          d3.max(segments, d=>Math.max(d.ageStart, d.ageEnd)) + 0.3
        ])
        .nice()
        .range([innerH, 0]);

      // grid
      g.append("g")
        .attr("class","grid")
        .call(d3.axisLeft(y).ticks(8).tickSize(-innerW).tickFormat(""));

      // axes
      g.append("g")
        .attr("class","axis")
        .attr("transform", `translate(0,${innerH})`)
        .call(d3.axisBottom(x).ticks(7));

      g.append("g")
        .attr("class","axis")
        .call(d3.axisLeft(y).ticks(8));

      // labels
      g.append("text")
        .attr("class","label")
        .attr("x", innerW)
        .attr("y", innerH + 40)
        .attr("text-anchor", "end")
        .text("日期");

      g.append("text")
        .attr("class","label")
        .attr("x", -8)
        .attr("y", -6)
        .attr("text-anchor", "start")
        .text("年齡（年）");

      // segments as lines
      const segG = g.append("g");

      segG.selectAll("line.segment")
        .data(segments)
        .join("line")
        .attr("class","segment")
        .attr("x1", d => x(d.start))
        .attr("y1", d => y(d.ageStart))
        .attr("x2", d => x(d.end))
        .attr("y2", d => y(d.ageEnd))
        .attr("stroke", "#222")
        .attr("stroke-width", 2)
        .attr("stroke-linecap", "round")
        .on("mousemove", (event, d) => {
          tooltip
            .style("opacity", 1)
            .style("left", event.clientX + "px")
            .style("top", event.clientY + "px")
            .html(`
              <div style="font-weight:700; margin-bottom:6px;">${d.name}</div>
              <div>區間：${fmtDateTW(d.start)} → ${fmtDateTW(d.end)}</div>
              <div>年齡：${d.ageStart.toFixed(3)} → ${d.ageEnd.toFixed(3)} 年</div>
              ${d.country ? `<div style="opacity:.85;">地區：${d.country}</div>` : ""}
              ${d.note ? `<div style="opacity:.85;">註記：${d.note}</div>` : ""}
            `);
        })
        .on("mouseleave", () => tooltip.style("opacity", 0));

      // change points at each start
      segG.selectAll("circle.point")
        .data(segments)
        .join("circle")
        .attr("class","point")
        .attr("cx", d => x(d.start))
        .attr("cy", d => y(d.ageStart))
        .attr("r", 4.5)
        .attr("fill", "#fff")
        .attr("stroke", "#222")
        .attr("stroke-width", 2)
        .on("mousemove", (event, d) => {
          tooltip
            .style("opacity", 1)
            .style("left", event.clientX + "px")
            .style("top", event.clientY + "px")
            .html(`
              <div style="font-weight:700; margin-bottom:6px;">${d.name}</div>
              <div>開始日期：${fmtDateTW(d.start)}</div>
              <div>當天年齡：約 ${d.ageStart.toFixed(3)} 年</div>
              <div style="opacity:.85;">出生：${fmtDateTW(d.birth)}</div>
            `);
        })
        .on("mouseleave", () => tooltip.style("opacity", 0));
    }

    async function main(){
      try{
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch ${DATA_URL} 失敗：HTTP ${res.status}`);
        const raw = await res.json();
        const segments = validateAndNormalize(raw);
        draw(segments);
      }catch(e){
        console.error(e);
        showError(
          "讀取/解析 data.json 失敗：\n" +
          (e?.message || String(e)) +
          "\n\n檢查：\n" +
          "1) index.html 與 data.json 是否同資料夾\n" +
          "2) 是否用 http://localhost 方式開啟（不要 file://）\n" +
          "3) 日期是否為 YYYY-MM-DD，end 可為 null"
        );
      }
    }

    main();
    window.addEventListener("resize", () => main(), { passive: true });
  </script>
</body>
</html>
