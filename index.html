<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在世最長壽者：日期 × 年齡（讀取 data.json）</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --card:#fafafa; --border:#e7e7e7; }
    body{ margin:0; font-family: system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; color:var(--fg); background:var(--bg); }
    .wrap{ max-width: 1080px; margin: 28px auto; padding: 0 16px 24px; }
    h1{ font-size: 20px; margin: 0 0 8px; }
    .sub{ color: var(--muted); margin: 0 0 14px; line-height: 1.55; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    #chartWrap{
      width: 100%;
      overflow: hidden; /* 圖表本身用 d3 zoom/pan，不靠 scrollbar */
      border-radius: 12px;
    }
    #chart{ width: 100%; }
    .axis text{ fill: var(--muted); font-size: 12px; }
    .axis path, .axis line{ stroke: #d9d9d9; }
    .grid line{ stroke:#e9e9e9; }
    .grid path{ display:none; }
    .label{ fill: var(--muted); font-size: 12px; }
    .tooltip{
      position: fixed; pointer-events:none; opacity:0;
      background: rgba(20,20,20,.92); color: #fff;
      padding: 10px 12px; border-radius: 10px; max-width: 360px;
      font-size: 12px; line-height: 1.35;
      transform: translate(10px, 10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 0; }
    .pill{ font-size:12px; color:var(--muted); background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; }
    .error{ white-space: pre-wrap; color:#b00020; font-size: 13px; margin-top: 10px; }
    code{ background:#f3f3f3; padding: 2px 6px; border-radius: 6px; }
    .hint{ user-select:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>在世最長壽者（世界最高齡在世者）年齡視覺化</h1>
    <p class="sub hint">
      讀取 <code>data.json</code>（同資料夾）<br/>
      橫軸：日期（可拖曳平移；滾輪可縮放）｜縱軸：該日期年齡（年齡 = (日期 − 出生日期) / 365.2425）<br/>
      規則：起點固定 <code>1951-01-01</code>；每筆 start = 前一筆 end；只在 end（最高點）畫圓點；Male 以藍色顯示
    </p>

    <div class="card">
      <div class="row" id="meta"></div>
      <div id="chartWrap"><div id="chart"></div></div>
      <div class="error" id="err" style="display:none;"></div>
    </div>

    <p class="sub" style="margin-top:14px;">
      若你直接雙擊開啟（file://）而出現 fetch 失敗，請用本機伺服器：<br/>
      macOS/Linux：<code>python3 -m http.server 8000</code>　Windows：<code>python -m http.server 8000</code><br/>
      然後瀏覽器開 <code>http://localhost:8000</code>
    </p>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    const DATA_URL = "./data.json";
    const DAYS_PER_YEAR = 365.2425;
    const SERIES_START_STR = "1951-01-01";
    const WINDOW_YEARS = 10; // 預設視窗約 10 年

    const tooltip = d3.select("#tooltip");
    const meta = d3.select("#meta");
    const errBox = d3.select("#err");

    function showError(msg){
      errBox.style("display","block").text(msg);
    }

    // 安全解析 YYYY-MM-DD（用 UTC 避免時區偏移）
    function parseISODate(s){
      if (s === null || s === undefined) return null;
      if (typeof s !== "string") return null;
      const m = s.trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = +m[1], mo = +m[2]-1, d = +m[3];
      return new Date(Date.UTC(y, mo, d));
    }

    function yearsBetween(birth, date){
      return (date - birth) / (1000*60*60*24) / DAYS_PER_YEAR;
    }

    function fmtDateTW(d){
      return new Intl.DateTimeFormat("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}).format(d);
    }

    function isMale(note){
      return typeof note === "string" && /male/i.test(note);
    }

    function validateAndNormalize(raw){
      if (!Array.isArray(raw)) throw new Error("data.json 必須是一個陣列（Array）。");

      const SERIES_START = parseISODate(SERIES_START_STR);
      const today = new Date();

      const items = raw.map((r, idx) => {
        const name = (r?.name ?? "").toString().trim();
        const birth = parseISODate(r?.birth);
        const end = (r?.end === null || r?.end === undefined) ? null : parseISODate(r?.end);

        if (!name) throw new Error(`第 ${idx+1} 筆缺少 name。`);
        if (!birth) throw new Error(`第 ${idx+1} 筆 birth 日期格式錯誤，需 YYYY-MM-DD。`);
        if (r?.end === undefined) throw new Error(`第 ${idx+1} 筆缺少 end（可為 null）。`);
        if (end === null) {
          // ok
        } else if (!end) {
          throw new Error(`第 ${idx+1} 筆 end 日期格式錯誤，需 YYYY-MM-DD 或 null。`);
        }

        return {
          name,
          country: r?.country ? String(r.country) : "",
          note: r?.note ? String(r.note) : "",
          birth,
          endRaw: end // Date 或 null
        };
      });

      const segs = [];
      let currentStart = SERIES_START;

      for (let i = 0; i < items.length; i++){
        const it = items[i];
        const start = currentStart;
        const end = (it.endRaw === null) ? today : it.endRaw;

        if (end <= start) {
          throw new Error(`第 ${i+1} 筆 end 必須晚於其計算出的 start（start=${start.toISOString().slice(0,10)}）。`);
        }
        if (start <= it.birth) {
          throw new Error(`第 ${i+1} 筆 start 必須晚於 birth（不合理）。`);
        }

        const ageStart = yearsBetween(it.birth, start);
        const ageEnd = yearsBetween(it.birth, end);

        segs.push({
          name: it.name,
          country: it.country,
          note: it.note,
          male: isMale(it.note),
          birth: it.birth,
          start,
          end,
          ageStart,
          ageEnd
        });

        if (it.endRaw === null) {
          if (i !== items.length - 1) {
            throw new Error(`第 ${i+1} 筆 end 是 null（代表延伸到今天），但後面仍有第 ${i+2} 筆資料，時間序列不一致。`);
          }
          break;
        } else {
          currentStart = it.endRaw;
        }
      }

      return segs;
    }

    function draw(segments){
      d3.select("#chart").selectAll("*").remove();
      meta.selectAll("*").remove();
      errBox.style("display","none").text("");

      const container = document.getElementById("chartWrap");
      const width = Math.max(360, container.clientWidth);
      const height = 560;

      const margin = { top: 18, right: 22, bottom: 52, left: 64 };
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      // meta
      meta.append("div").attr("class","pill").text(`段數：${segments.length}`);
      meta.append("div").attr("class","pill")
        .text(`全區間：${fmtDateTW(d3.min(segments, d=>d.start))} → ${fmtDateTW(d3.max(segments, d=>d.end))}`);
      meta.append("div").attr("class","pill").text(`視窗：約 ${WINDOW_YEARS} 年（可拖曳平移 / 滾輪縮放）`);

      // 顏色：country 對應（穩定的類別色盤）；Male 強制藍色
      const countries = Array.from(new Set(segments.map(d => d.country || "Unknown")));
      const countryColor = d3.scaleOrdinal()
        .domain(countries)
        .range(d3.schemeTableau10.concat(d3.schemeSet3).concat(d3.schemePaired));

      const MALE_BLUE = "#1f77b4"; // d3 tableau blue

      // y domain（全資料）
      const yMin = d3.min(segments, d => Math.min(d.ageStart, d.ageEnd)) - 0.3;
      const yMax = d3.max(segments, d => Math.max(d.ageStart, d.ageEnd)) + 0.3;

      // x domain（全資料）
      const xFullMin = d3.min(segments, d => d.start);
      const xFullMax = d3.max(segments, d => d.end);

      // 預設視窗：從 SERIES_START 開始往後 10 年（若資料不足則 clamp）
      const initialStart = parseISODate(SERIES_START_STR) || xFullMin;
      const initialEnd = new Date(Date.UTC(
        initialStart.getUTCFullYear() + WINDOW_YEARS,
        initialStart.getUTCMonth(),
        initialStart.getUTCDate()
      ));
      const xInitMin = (initialStart < xFullMin) ? xFullMin : initialStart;
      const xInitMax = (initialEnd > xFullMax) ? xFullMax : initialEnd;

      // base scales
      const xBase = d3.scaleTime().domain([xFullMin, xFullMax]).range([0, innerW]);
      const x = d3.scaleTime().domain([xInitMin, xInitMax]).range([0, innerW]);

      const y = d3.scaleLinear().domain([yMin, yMax]).nice().range([innerH, 0]);

      const svg = d3.select("#chart")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("width", "100%")
        .attr("height", height);

      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      // clip（避免拖曳時圖形跑出繪圖區）
      const clipId = "clip-plot";
      svg.append("defs")
        .append("clipPath")
        .attr("id", clipId)
        .append("rect")
        .attr("x", margin.left)
        .attr("y", margin.top)
        .attr("width", innerW)
        .attr("height", innerH);

      // grid（y 固定不用重算）
      const gridG = g.append("g")
        .attr("class","grid")
        .call(d3.axisLeft(y).ticks(8).tickSize(-innerW).tickFormat(""));

      // axes
      const xAxisG = g.append("g")
        .attr("class","axis")
        .attr("transform", `translate(0,${innerH})`);

      const yAxisG = g.append("g")
        .attr("class","axis")
        .call(d3.axisLeft(y).ticks(8));

      // labels
      g.append("text")
        .attr("class","label")
        .attr("x", innerW)
        .attr("y", innerH + 40)
        .attr("text-anchor", "end")
        .text("日期（可拖曳平移）");

      g.append("text")
        .attr("class","label")
        .attr("x", -8)
        .attr("y", -6)
        .attr("text-anchor", "start")
        .text("年齡（年）");

      // plot layers（都放在 clip 裡）
      const plot = g.append("g").attr("clip-path", `url(#${clipId})`);

      // area generator（每段兩點，向下填到底部 innerH，形成梯形）
      const areaGen = d3.area()
        .x(d => x(d.date))
        .y0(innerH)
        .y1(d => y(d.age))
        .curve(d3.curveLinear);

      // line generator
      const lineGen = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.age))
        .curve(d3.curveLinear);

      // 轉成兩點資料，方便 area/line
      function segToPoints(s){
        return [
          { date: s.start, age: s.ageStart },
          { date: s.end, age: s.ageEnd }
        ];
      }

      // groups
      const areasG = plot.append("g");
      const linesG = plot.append("g");
      const endDotsG = plot.append("g");

      function segStroke(s){
        if (s.male) return MALE_BLUE;
        return countryColor(s.country || "Unknown");
      }
      function segFill(s){
        if (s.male) return MALE_BLUE;
        return countryColor(s.country || "Unknown");
      }

      function render(){
        // axis update
        xAxisG.call(d3.axisBottom(x).ticks(7));

        // areas (shadow trapezoids)
        areasG.selectAll("path.area")
          .data(segments, d => d.name + "|" + d.start.toISOString())
          .join("path")
          .attr("class","area")
          .attr("d", d => areaGen(segToPoints(d)))
          .attr("fill", d => segFill(d))
          .attr("fill-opacity", 0.18);

        // lines
        linesG.selectAll("path.line")
          .data(segments, d => d.name + "|" + d.start.toISOString())
          .join("path")
          .attr("class","line")
          .attr("d", d => lineGen(segToPoints(d)))
          .attr("fill", "none")
          .attr("stroke", d => segStroke(d))
          .attr("stroke-width", 2.2)
          .attr("stroke-linecap", "round");

        // end dots (highest point at end)
        endDotsG.selectAll("circle.enddot")
          .data(segments, d => d.name + "|" + d.start.toISOString())
          .join("circle")
          .attr("class","enddot")
          .attr("cx", d => x(d.end))
          .attr("cy", d => y(d.ageEnd))
          .attr("r", 4.8)
          .attr("fill", "#fff")
          .attr("stroke", d => segStroke(d))
          .attr("stroke-width", 2.2);

        // tooltip interactions (attach to lines + dots)
        linesG.selectAll("path.line")
          .on("mousemove", (event, d) => {
            tooltip
              .style("opacity", 1)
              .style("left", event.clientX + "px")
              .style("top", event.clientY + "px")
              .html(`
                <div style="font-weight:700; margin-bottom:6px;">${d.name}${d.male ? "（Male）" : ""}</div>
                <div>區間：${fmtDateTW(d.start)} → ${fmtDateTW(d.end)}</div>
                <div>年齡：${d.ageStart.toFixed(3)} → ${d.ageEnd.toFixed(3)} 年</div>
                ${d.country ? `<div style="opacity:.85;">國家：${d.country}</div>` : ""}
                ${d.note ? `<div style="opacity:.85;">註記：${d.note}</div>` : ""}
              `);
          })
          .on("mouseleave", () => tooltip.style("opacity", 0));

        endDotsG.selectAll("circle.enddot")
          .on("mousemove", (event, d) => {
            tooltip
              .style("opacity", 1)
              .style("left", event.clientX + "px")
              .style("top", event.clientY + "px")
              .html(`
                <div style="font-weight:700; margin-bottom:6px;">${d.name}${d.male ? "（Male）" : ""}</div>
                <div>結束點（最高點）：${fmtDateTW(d.end)}</div>
                <div>當天年齡：約 ${d.ageEnd.toFixed(3)} 年</div>
                ${d.country ? `<div style="opacity:.85;">國家：${d.country}</div>` : ""}
              `);
          })
          .on("mouseleave", () => tooltip.style("opacity", 0));
      }

      // 初次 render
      render();

      // zoom/pan：只在 x 軸上操作
      // 目標：預設約 10 年視窗；可左右拖曳；滾輪縮放
      // scaleExtent: 最小 1（全靠初始 domain 控制），最大依全域/視窗比
      const fullSpan = xFullMax - xFullMin;
      const initSpan = xInitMax - xInitMin;
      const maxK = Math.max(1, fullSpan / initSpan);

      const zoom = d3.zoom()
        .scaleExtent([1, maxK])
        .translateExtent([[0, 0], [innerW, innerH]])
        .extent([[0, 0], [innerW, innerH]])
        .on("zoom", (event) => {
          // 用 base scale rescale，然後把 domain 更新到 x
          const zx = event.transform.rescaleX(xBase);
          x.domain(zx.domain());
          render();
        });

      // 將 zoom 行為掛到 svg 的 plot 區域（不含 margin）
      // 用一個透明 rect 接收事件
      plot.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", innerW)
        .attr("height", innerH)
        .attr("fill", "transparent")
        .style("cursor", "grab")
        .call(zoom)
        .on("mousedown", function(){ d3.select(this).style("cursor","grabbing"); })
        .on("mouseup", function(){ d3.select(this).style("cursor","grab"); });

      // 將 zoom 初始化到「約 10 年視窗」
      // 透過設定 transform，使目前 x(domain) = xInit
      // k = fullSpan / initSpan，平移用 xBase 映射起點
      const k0 = fullSpan / initSpan;
      const tx0 = -xBase(xInitMin) * k0;
      const t0 = d3.zoomIdentity.translate(tx0, 0).scale(k0);
      plot.select("rect").call(zoom.transform, t0);
    }

    async function main(){
      try{
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch ${DATA_URL} 失敗：HTTP ${res.status}`);
        const raw = await res.json();
        const segments = validateAndNormalize(raw);
        draw(segments);
      }catch(e){
        console.error(e);
        showError(
          "讀取/解析 data.json 失敗：\n" +
          (e?.message || String(e)) +
          "\n\n檢查：\n" +
          "1) index.html 與 data.json 是否同資料夾\n" +
          "2) 是否用 http://localhost 方式開啟（不要 file://）\n" +
          "3) 日期是否為 YYYY-MM-DD，end 可為 null\n" +
          "4) end: null 只能在最後一筆"
        );
      }
    }

    main();
    window.addEventListener("resize", () => main(), { passive: true });
  </script>
</body>
</html>
